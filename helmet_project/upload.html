<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>機車安全帽辨識</title>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="spinner.css">
<script src="jquery-3.5.1.min.js"></script>
<style>
	.header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-top: 10px;
		margin-bottom: 20px;
		margin-left: auto;
		margin-right: 10%;
	}

	.header .buttons button {
		background-color: #007bff;
		color: white;
		border: none;
		padding: 10px 20px;
		border-radius: 5px;
		margin-left: 10px;
		cursor: pointer;
	}

	.header .buttons button:hover {
		background-color: #0056b3;
	}
	.upload-container {
		width: 12cm;
		height: 7cm;
		border: 2px dashed #4CAF50;
		display: flex;
		justify-content: center;
		align-items: center;
		position: relative;
		cursor: pointer;
		border-radius: 4px;
		text-align: center;
		flex-direction: column;
		margin-bottom: 20px;
	}
    .upload-container:hover {
        background-color: #f0f0f0;
    }

    .custom-file-upload {
        padding: 6px 12px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
    }

    .custom-file-upload:hover {
        background-color: #45a049;
    }

    input[type="file"] {
        display: none;
    }

    .upload-container.dragover {
        background-color: #e0e0e0;
    }

    .file-name {
        margin-top: 10px;
        color: #333;
    }
	
	.btn {
		width: 70px;
		height: 35px;
		background-color: #ACD6FF;
		border: 1px dashed;
		border-radius: 25%;
		font-weight: bold;
	}
	
	.btn:hover {
		background-color: #84C1FF;
		pointer: cursor;
	}
	
	.btn:active {
		background-color: #0080FF;
	}
</style>
</head>
<body>
	<div class="header">
	</div>
	<h1>機車安全帽辨識</h1>
	<form id="uploadForm" enctype="multipart/form-data" method="post" style="text-align:center;">
		<label for="fileUpload"><div class="upload-container" id="uploadContainer">
			<label for="fileUpload" class="custom-file-upload">選擇檔案</label>
			<input type="file" id="fileUpload" name="fileUpload">
			<div class="file-name" id="fileName"></div>
		</div></label>
		<input type="button" class="btn" value="辨識" onclick="submitForm()">
	</form>
	<div class="background" style="display: none;" id="spinner">
		<div class="spinner">
			<div class="word" id="progress">上傳中</div>
			<div class="spinnerBlue spinnerSector"></div>
			<div class="spinnerGreen spinnerSector"></div>
			<div class="spinnerRed spinnerSector"></div>
		</div>
	</div>
<script>
    const uploadContainer = document.getElementById('uploadContainer');
    const fileUpload = document.getElementById('fileUpload');
    const fileName = document.getElementById('fileName');

    /*uploadContainer.addEventListener('click', () => {
        fileUpload.click();
    });*/

    uploadContainer.addEventListener('dragover', (event) => {
        event.preventDefault();
        uploadContainer.classList.add('dragover');
    });

    uploadContainer.addEventListener('dragleave', () => {
        uploadContainer.classList.remove('dragover');
    });

    uploadContainer.addEventListener('drop', (event) => {
        event.preventDefault();
        uploadContainer.classList.remove('dragover');
        fileUpload.files = event.dataTransfer.files;
        fileName.textContent = fileUpload.files[0].name;
    });

    fileUpload.addEventListener('change', () => {
		try {
			fileName.textContent = fileUpload.files[0].name;
		}
		catch (e) {}
    });
	
	function submitForm() {
		const file_name = fileName.textContent;
		const extension = file_name.split(".").pop().toLowerCase();
		const image_extension = ["jpg", "jpeg", "png", "gif", "bmp", "tiff", "webp"];
		const video_extension = ["mp4", "avi", "mov", "wmv", "mkv", "flv", "webm", "ts"];;
		
		if (file_name != "") {
			if (fileUpload.files[0].size <= 1073741824) {
				if (image_extension.includes(extension) || video_extension.includes(extension)) {			
					$("#spinner").show();
					
					const $uploadForm = $("#uploadForm");
					const $upload = $("<input>", {type: "hidden", name: "upload"});
					$uploadForm.append($upload);

					formdata = new FormData($uploadForm[0]);
					
					$.ajax({
						url: "./file_receive.php",
						type: "POST",
						data: formdata,
						processData: false,
						contentType: false,
						success: function(response) {
							const return_data = JSON.parse(response);
							
							if (return_data["status"] == "success") {
								const $detectForm = $("<form>", {method: "post", action: "./helmet_detect.php"});
								
								$("<input>", {name: "id", value: return_data.id, type: "hidden"}).appendTo($detectForm);
								
								$("<input>", {name: "file_name", value: return_data.file_name, type: "hidden"}).appendTo($detectForm);
								
								$("<input>", {name: "mode", value: return_data.mode, type: "hidden"}).appendTo($detectForm);
								
								$("body").append($detectForm);
								$detectForm.submit();
							}
							else if (return_data["status"] == "upload_error") {
								alert("檔案毀損，上傳失敗。");
								$("$spinner").hide();
								fileUpload.files = new DataTransfer().files;
								fileName.textContent = "";
							}
							else if (return_data["status"] == "format_error") {
								alert("上傳格式錯誤。");
								$("$spinner").hide();
								fileUpload.files = new DataTransfer().files;
								fileName.textContent = "";
							}
						}
					});
				}
				else {
					alert("不支援"+extension+"檔案格式。");
					fileUpload.files = new DataTransfer().files;
					fileName.textContent = "";
				}
			}
			else {
				alert("上傳檔案過大(需小於1GB)。");
				fileUpload.files = new DataTransfer().files;
				fileName.textContent = "";
			}
		}
	}
</script>
</body>
</html>